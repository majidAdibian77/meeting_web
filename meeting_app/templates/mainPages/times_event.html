<!DOCTYPE html>
{% extends 'mainPages/base.html' %}

{% block body_block %}
    <head>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/fullcalendar.css"/>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/fullcalendar.min.js"></script>

        <script>
            $(document).ready(function () {
                var calendar = $('#calendar').fullCalendar({
                    header: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'month,agendaWeek,agendaDay'
                    },
                    events: [
                        {% for time in all_timespan %}
                            {
                                title: '{{ event.title }}',
                                start: '{{ time.start|date:"Y-m-d"}}',
                                end: '{{ time.end|date:"Y-m-d" }}',
                                id: '{{ time.id }}',
                            },
                        {% endfor %}
                    ],
                    selectable: true,
                    selectHelper: true,
                    editable: true,
                    eventLimit: true,
                    select: function (start, end, allDay) {
                        var title = '{{ event.title }}';
                        if (title) {
                            var start = $.fullCalendar.formatDate(start, "Y-MM-DD HH:mm:ss");
                            var end = $.fullCalendar.formatDate(end, "Y-MM-DD HH:mm:ss");
                            $.ajax({
                                type: "GET",
                                url: '/add_time',
                                data: {'event_pk': '{{ event.pk }}', 'start': start, 'end': end},
                                dataType: "json",
                                success: function (data) {
                                    alert("Added Successfully");
                                    $('#calendar').fullCalendar("refetchEvents");
                                },
                                failure: function (data) {
                                    alert('There is a problem!!!');
                                }
                            });
                        }
                    },
                    eventResize: function (event) {
                        var start = $.fullCalendar.formatDate(event.start, "Y-MM-DD HH:mm:ss");
                        var end = $.fullCalendar.formatDate(event.end, "Y-MM-DD HH:mm:ss");
                        var title = event.title;
                        var id = event.id;
                        $.ajax({
                            type: "GET",
                            url: '/update_time',
                            data: {'title': title, 'start': start, 'end': end, 'id': id},
                            dataType: "json",
                            success: function (data) {
                                calendar.fullCalendar('refetchEvents');
                                alert('Event Update');
                            },
                            failure: function (data) {
                                alert('There is a problem!!!');
                            }
                        });
                    },

                    eventDrop: function (event) {
                        var start = $.fullCalendar.formatDate(event.start, "Y-MM-DD HH:mm:ss");
                        var end = $.fullCalendar.formatDate(event.end, "Y-MM-DD HH:mm:ss");
                        var title = event.title;
                        var id = event.id;
                        alert(id);
                        $.ajax({
                            type: "GET",
                            url: '/update_time' +
                            '',
                            data: {'title': title, 'start': start, 'end': end, 'id': id},
                            dataType: "json",
                            success: function (data) {
                                calendar.fullCalendar('refetchEvents');
                                alert('Event Update');
                            },
                            failure: function (data) {
                                alert('There is a problem!!!');
                            }
                        });
                    },

                    eventClick: function (event) {
                        if (confirm("Are you sure you want to remove it?")) {
                            var id = event.id;
                            $.ajax({
                                type: "GET",
                                url: '/remove_time',
                                data: {'id': id},
                                dataType: "json",
                                success: function (data) {
                                    calendar.fullCalendar('refetchEvents');
                                    alert('Event Removed');
                                },
                                failure: function (data) {
                                    alert('There is a problem!!!');
                                }
                            });
                        }
                    },

                });
            });

            </script>

    </head>
    <!-- container -->
    <div class="container">
        <ol class="breadcrumb">
            <li><a href="{% url 'home' %}">صفحه اصلی</a></li>
            <li class="active">رویداد جدید</li>
        </ol>

        <div class="row">

            <!-- Article main content -->
            <article class="col-xs-12 maincontent">
                <header class="page-header">
                    <h1 class="page-title">زمان بندی رویداد</h1>
                </header>

                <div class="col-md-6 col-md-offset-3 col-sm-8 col-sm-offset-2">
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <h3 class="thin text-center">زمان بندی رویداد</h3>
                            <hr>
                            <div id="calendar"></div>
                            <hr>
                            <a>
                                <button onclick="send_email({{ event.pk }}, {{ user.pk }})" class="btn btn-primary">ثبت رویداد</button>
                                <a href="{% url 'event_type' pk=event.pk %}" class="btn btn-primary">بازگشت</a>
                            </a>
                        </div>
                    </div>
                </div>
            </article>
            <!-- /Article -->
        </div>
    </div>    <!-- /container -->
{% endblock %}
